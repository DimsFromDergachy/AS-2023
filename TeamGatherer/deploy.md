# Требования
## Техничесие
### Сервер приложения
**Минимальные:**  
OS: Ubuntu Jammy 22.04 (LTS)  
16 Gb оперативной памяти  
100 Gb дискового пространства  

**Рекомендуемые:**  
Процессор: AMD EPYC 7763 64 ядра 8 каналов памяти  
64 Tb оперативной памяти  
1000 Ptb дискового пространства  
### Сервер БД
**Минимальные:**  
OS: Ubuntu Jammy 22.04 (LTS)  
16 Gb оперативной памяти  
200 Gb дискового пространства  
> Примечание: требования к серверу БД  зависят от объёма данных.
## Окружение
- Сервер приложений должен иметь доступ к сети интернет.
- В сервере приложений должен быть заведён пользователь с правами выполнения команд с использованием sudo (пользователь в группе sudouser)
- Настроенный и установленный docker 


Установку docker можно выполнить несколькими способами:
1. Выполнить в консоли команду `sudo snap install docker` если будет запрошен пароль необходимо ввести пароль пользователя
2. Выполнить шаги `Set up Docker Repository` и `Install Docker engine` в инструкции https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository

После установки docker необходимо выполнить донастройку (раздел `Manage Docker as a non-root user`) по инструкции на официальном сайте: https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user
> Важно: после выполнения инструкций по донастройке перезагрузить сервер приложений на котором будет устанавливаться приложение. 

Так же требуется развернутый экземпляр СУБД Postgres на Сервере БД, версии не ниже 15.  
В экземпляре с БД необходимо создать настроить пользователя с паролем и создать базу данных для `системы`, при этом пользователь должен обладать всеми правами на созданную базу данных.  
За созданием пользователя, базы занных и настройкой доступа можно обратиться к инструкции Postgres или настроить сервер БД любым другим способом.

С сервера приложения должен быть доступ к серверу БД (на сервере БД открыт доступ по порту 5432 для сервера приложения и сервер приложения успешно пингует сервер БД).

> При затруднениях в понимании терминологии и инструкции `Обратитесь к вашему системному администратору.` © :)

# Установка
## Конфигурация
### Настройка подключения
В директории дистрибутива, где расположен файл с расширением sln.  
Необходимо настроить файл `Server/appsetting.Production.json` (файл `appsetting.Production.json` в директории `Server`).

В файле, вместо слов `строка подключения` задать, корректную для Postgres, строку подключения к БД, например:  
`Host=172.30.5.30;Port=5432;CommandTimeout=300;Database=blazorApp_db;Username=postgres;Password=password;`.
> Параметры строки подключения должны быть такие какие были заданы при настройке в разделе `Требования к серверу приложений`/`Окружение` 
  Т.е. вместо 172.30.5.30 - адрес сервера с запущенным экземпляром Postgres.
  Вместо `blazorApp_db` указано название вашей БД.
  Вместо `postgres` - логин созданного пользователя.
  Вместо `password` - пароль.

Далее в файле, вместо слов `IP & port к ИС Кадры` задать url к ИС кадры  
Вместо `Логин к ИС Кадры` задать логин пользователя в системе ИС Кадры  
Вместо `Пароль к ИС кадры` задать пароль пользователя в системе ИС Кадры

#### Пример результирующего файла:
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AppSettings": {
    "Token": "my top secret key"
  },
  "ConnectionString": "Host=172.30.5.30;Port=5432;CommandTimeout=300;Database=blazorApp_db;Username=postgres;Password=password;",
  "StaffCOnfig": {
    "Url": "http://172.30.5.31:5000/",
    "Login": "admin",
    "Password": "password",
    "HrKey": "hr"
  },
  "Kestrel": {
    "Certificates": {
      "Default": {
        "Path": "teamgatherer.pfx",
        "Password": "123"
      }
    }
  }
}
```
### Настройка сертификатов (не обязательно)
> Важно: система не терает работоспособности если этот шаг пропустить.

Сейчас в приложении используетя самоподписанный SSL-сертификат при доступе к системе.
При необходимости использовать специальный сертификат, заверенный удостоверяющим центром, небоходимо получить такой сертификат и перед выполнением запуска `системы` в дистрибутиве, в заменить файл `Server/teamgatherer.pfx` и изменить конфигурацию:  
в ключе `Kestrel:Certificates:Default:Password` json-файла `appsetting.Production.json` указать пароль вашего сертификата.
> Важно: на текущий момент `система` поддерживает работу с сертификатами pfx-формата с закрытым ключом и парольной фразой и только если сертификат называется `teamgatherer.pfx`.

### Настройка идентификатора должности HR-специалиста (при необходимости)
Если идентификатор должности HR-сотрудника в ИС Кадры отличается от указанного в файле `appsetting.Production.json` в ключе `StaffCOnfig:HrKey` можно задать правильный идентификатор должности.
> Важно: не меняйте идентификатор должности если он **НЕ** отличается от того, что используется в ИС Кадры

## Запуск `системы`
После настройки и предварительного конфигурирования можно приступать к запуску системы.
Необходимо открыть терминал в директории где расположен файл с раширением sln.

В терминале выполнить команду:
```shell
docker build --no-cache -t teamgatherer:latest .
```
> Важно: Обратите внимание на точку в конце - это не опечатся, она нужна.

После завершения выполнить команду:
```shell
docker-compose up -d
```

В терминале должна появиться надпись:

```shell
Container teamgatherer Started
```

Чтобы убедиться в успешном запуске можно выполнить в терминале команду 
```shell
docker-compose ps -a
```
Будет выведено табличное представление запущенного приложения, в колонке `STATUS` должна быть фраза дающая представление о том, сколько работает приложение, например `Up 8760 hours`

## Проверка доступности приложения:
### Локально
В любом браузере,  рекомендуется Cromium версии 110 и выше, в адресной строке ввести:
```
https://localhost
```
В случае ошибки ERR_CERT_COMMON_NAME_INVALID нажать кнопку `Дополнительно` и ниже на ссылку `Перейти на сайт localhost (небезопасно)`.
### Из других машин внутри сети с сервером приложения
Убедиться, что внутри сети есть доступ к серверу приложения и у сервера приложения открыты стандартные порты 80 и 443.  
В любом браузере,  рекомендуется Cromium версии 110 и выше, в адресной строке ввести:
```
https://{IP сервера приложения}
```
В случае ошибки ERR_CERT_COMMON_NAME_INVALID нажать кнопку `Дополнительно` и ниже на ссылку `Перейти на сайт localhost (небезопасно)`.

> В любом из способов проверки приложения должна открыться страница в браузере представляющая собой приетственную страницу `системы`.
